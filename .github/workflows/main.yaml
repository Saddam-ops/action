name: CICD

on: 
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        jdk: [temurin-11, temurin-17]
      fail-fast: false
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up JDK ${{ matrix.jdk }}
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ matrix.jdk }}
        cache: 'maven'
    
    - name: Build Artifact
      run: mvn -B clean install
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: app-${{ matrix.os }}-jdk${{ matrix.jdk }}
        path: target/*.war
        retention-days: 5
    
    - name: Notify Build Failure
      if: failure()
      run: echo "Build failed! Please check the logs"
      
  testing:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        cache: 'maven'
    
    - name: Download Build Artifacts
      uses: actions/download-artifact@v3
    
    - name: Run Tests
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      run: mvn -B test
    
    - name: Code Quality Analysis
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      run: |
        mvn checkstyle:checkstyle
        mvn pmd:pmd
    
    - name: Skip Tests for Feature Branches
      if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
      run: echo "Skipping tests on feature branch: ${GITHUB_REF#refs/heads/}"

  security-scans:
    needs: [build, testing]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Run Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        severity: 'CRITICAL,HIGH,MEDIUM'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Scan Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
